<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.yunovo.iov.fc.dao.ICcRealnameMapper">

	<select id="getItemsPage" resultType="cn.yunovo.iov.fc.model.entity.CcRealname">
	
		SELECT R.card_id,R.user_id,R.device_sn,R.card_iccid,R.owner_name,R.owner_gender,R.owner_cdi,
			R.cdi_img1,R.cdi_img2,R.cdi_img3,R.cdi_status,R.give_value,R.give_time,R.time_added,R.time_modify,
			R.time_audit,C.org_id, C.time_last, C.time_active, R.update_by
		FROM
			cc_realname AS R
		INNER JOIN cc_gprs_card C ON C.card_id = R.card_id
		WHERE
			1 = 1
		
		<choose>

			<when test="org_id != null">
				AND C.org_id = #{org_id}
			</when>
			<otherwise>
				<choose>
					<when test='orgpos == "*"'>

					</when>
					<otherwise>
						AND C.org_id IN
						<foreach collection="orgs" item="id" index="index"
							open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</otherwise>

		</choose>
		
		<if test="card_iccid != null">
			<bind name="card_iccid_bind" value="'%'+card_iccid+'%'" />
			AND R.card_iccid LIKE #{card_iccid_bind}
		</if>
		
		<if test="date_start != null">
			<![CDATA[  AND R.time_added >= #{date_start} ]]>
		</if>

		<if test="date_end != null">
			<![CDATA[ AND R.time_added <= #{date_end} ]]>
		</if>
		
		<if test="status != null">
			<![CDATA[ AND R.cdi_status <= #{status} ]]>
		</if>
		
		
	</select>
	
	<select id="getItemsPageExport" resultType="cn.yunovo.iov.fc.model.export.CcRealnameExportBean">
	
		SELECT R.device_sn,R.card_iccid,R.owner_name,R.owner_cdi,
			R.cdi_img1,R.cdi_img2,R.cdi_img3,R.cdi_status,R.time_added
		FROM
			cc_realname AS R
		INNER JOIN cc_gprs_card C ON C.card_id = R.card_id
		WHERE
			1 = 1
		
		<choose>

			<when test="org_id != null">
				AND C.org_id = #{org_id}
			</when>
			<otherwise>
				<choose>
					<when test='orgpos == "*"'>

					</when>
					<otherwise>
						AND C.org_id IN
						<foreach collection="orgs" item="id" index="index"
							open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</otherwise>

		</choose>
		
		<if test="card_iccid != null">
			<bind name="card_iccid_bind" value="'%'+card_iccid+'%'" />
			AND R.card_iccid LIKE #{card_iccid_bind}
		</if>
		
		<if test="date_start != null">
			<![CDATA[  AND R.time_added >= #{date_start} ]]>
		</if>

		<if test="date_end != null">
			<![CDATA[ AND R.time_added <= #{date_end} ]]>
		</if>
		
		<if test="status != null">
			<![CDATA[ AND R.cdi_status <= #{status} ]]>
		</if>
		
		order by R.cdi_status desc,R.time_added desc
	</select>
	
	<!-- 获取实名卡数 -->
	<select id="getRlnameTotalByStatus" resultType="Integer">
		
		SELECT COUNT(RL.card_id) FROM cc_realname RL INNER JOIN cc_gprs_card GC ON GC.card_id = RL.card_id WHERE RL.cdi_status = #{cdi_status}
		
		<choose>
			<when test='orgpos == "*"'>

			</when>
			<otherwise>
				AND GC.org_id IN
				<foreach collection="orgs" item="id" index="index"
					open="(" close=")" separator=",">
					#{id}
				</foreach>
			</otherwise>
		</choose>
	
	</select>

	<select id="getByCardId" resultType="cn.yunovo.iov.fc.model.entity.CcRealname">
		
		SELECT
			card_id,user_id,device_sn,card_iccid,owner_name,owner_gender,owner_cdi,cdi_img1,cdi_img2,cdi_img3,
			cdi_status,give_value,give_time,time_added,time_modify,time_audit
		FROM	cc_realname
			where card_id = #{card_id}
	
	</select>
	
	<update id="updateIccidByCardid">
	
		UPDATE cc_realname SET card_iccid = CONCAT(card_iccid, '_'), time_modify = NOW()
		<if test="user_id != null">
		, user_id = #{user_id}
		</if>
		
		 WHERE card_id = #{card_id}
	</update>
	
</mapper>
