<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.yunovo.iov.fc.dao.ICcStatsMonthMapper">

	<select id="getMonthsByOrgs" resultType="String">

		SELECT how_month FROM cc_stats_month s
		INNER JOIN cc_gprs_card c on
		s.card_id = c.card_id
 	WHERE 1 =1 		
		AND c.org_id IN
		<foreach collection="orgs" item="id" index="index" open="("
			close=")" separator=",">
			#{id}
		</foreach>
		GROUP BY s.how_month ORDER BY s.how_month DESC
	</select>


	<select id="getAllMonths" resultType="java.lang.String">
		SELECT
		how_month FROM cc_stats_month
		GROUP BY how_month
		ORDER BY
		how_month DESC
	</select>

	<select id="queryItemsPage"
		resultType="cn.yunovo.iov.fc.model.entity.CcStatsMonth">

		SELECT s.*,c.card_iccid, c.org_id,
		c.card_type,c.time_active,c.time_added FROM cc_stats_month s INNER
		JOIN cc_gprs_card C ON S.card_id = C.card_id
		WHERE 1 = 1

		<choose>

			<when test="org_id != null">
				AND c.org_id = #{org_id}
			</when>
			<otherwise>
				<choose>
					<when test='orgpos == "*"'>

					</when>
					<otherwise>
						c.org_id IN
						<foreach collection="orgs" item="id" index="index" open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</otherwise>

		</choose>

		<if test="card_type != null">
			AND c.card_type = #{card_type}
		</if>

		<if test="card_iccid != null">
			<bind name="card_iccid_bind" value="'%'+card_iccid+'%'" />
			AND C.card_iccid LIKE #{card_iccid_bind}
		</if>

		<if test="mdate != null">
			AND s.how_month = #{mdate}
		</if>
	</select>
	
	<select id="queryItemsPageExport"
		resultType="cn.yunovo.iov.fc.model.export.CcStatsMonthExportBean">

		SELECT s.how_month,s.month_used,c.card_iccid, c.org_id,
		c.card_type,c.time_active,c.time_added FROM cc_stats_month s INNER
		JOIN cc_gprs_card C ON S.card_id = C.card_id
		WHERE 1 = 1

		<choose>

			<when test="org_id != null">
				AND c.org_id = #{org_id}
			</when>
			<otherwise>
				<choose>
					<when test='orgpos == "*"'>

					</when>
					<otherwise>
						c.org_id IN
						<foreach collection="orgs" item="id" index="index" open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</otherwise>

		</choose>

		<if test="card_type != null">
			AND c.card_type = #{card_type}
		</if>

		<if test="card_iccid != null">
			<bind name="card_iccid_bind" value="'%'+card_iccid+'%'" />
			AND C.card_iccid LIKE #{card_iccid_bind}
		</if>

		<if test="mdate != null">
			AND s.how_month = #{mdate}
		</if>
		
		order by 
	</select>

	<select id="queryItemsPageCount" resultType="Long">

		SELECT count(*) FROM cc_stats_month s INNER JOIN cc_gprs_card c ON
		s.card_id = c.card_id
		WHERE 1 = 1

		<choose>

			<when test="org_id != null">
				AND c.org_id = #{org_id}
			</when>
			<otherwise>
				<choose>
					<when test='orgpos == "*"'>

					</when>
					<otherwise>
						AND c.org_id IN
						<foreach collection="orgs" item="id" index="index"
							open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</otherwise>

		</choose>

		<if test="card_type != null">
			AND c.card_type = #{card_type}
		</if>

		<if test="card_iccid != null">
			<bind name="card_iccid_bind" value="'%'+card_iccid+'%'" />
			AND c.card_iccid LIKE #{card_iccid_bind}
		</if>

		<if test="mdate != null">
			AND s.how_month = #{mdate}
		</if>
	</select>

	<select id="usedTotal" resultType="Long">

		SELECT SUM(S.month_used) FROM cc_stats_month s INNER JOIN cc_gprs_card
		c ON s.card_id = c.card_id
		WHERE 1 = 1
		<choose>

			<when test="org_id != null">
				AND c.org_id = #{org_id}
			</when>
			<otherwise>
				<choose>
					<when test='orgpos == "*"'>

					</when>
					<otherwise>
						c.org_id IN
						<foreach collection="orgs" item="id" index="index"
							open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</otherwise>

		</choose>

		<if test="card_type != null">
			AND c.card_type = #{card_type}
		</if>

		<if test="card_iccid != null">
			<bind name="card_iccid_bind" value="'%'+card_iccid+'%'" />
			AND c.card_iccid LIKE #{card_iccid_bind}
		</if>

		<if test="mdate != null">
			AND s.how_month = #{mdate}
		</if>
	</select>
	
	<select id="getMonthUsePage" resultType="cn.yunovo.iov.fc.model.entity.CcStatsMonth">
	
		SELECT how_month,card_id,month_used,month_unused,month_over,month_wlist,time_modify
		FROM
			cc_stats_month
		WHERE
			card_id = #{card_id}
		
	</select>
	
	<select id="getWlistTotalByCardId" resultType="Double">
		SELECT SUM(month_wlist) FROM `cc_stats_month` WHERE card_id = #{card_id}
	</select>

	<update id="updateForSql">
		${value}
	</update>

</mapper>
