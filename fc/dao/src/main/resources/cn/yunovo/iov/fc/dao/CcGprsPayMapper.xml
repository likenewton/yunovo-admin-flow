<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.yunovo.iov.fc.dao.ICcGprsPayMapper">

	<select id="getPayCountPage"
		resultType="cn.yunovo.iov.fc.model.result.PayCountResultBean">
	
		<![CDATA[
		SELECT org_id, COUNT(pay_id) AS pay_count, SUM(IF(gprs_amount < 9999999, gprs_amount, 0)) AS gprs_amount,
		SUM(gprs_price) AS money_count, SUM(rebate_money) AS rebate_money FROM cc_gprs_pay WHERE is_paid = 1 AND pay_method > 0
		
		]]>

		<choose>

			<when test="org_id != null">
				AND org_id = #{org_id}
			</when>
			<otherwise>
				<choose>
					<when test='orgpos == "*"'>

					</when>
					<otherwise>
						AND org_id IN
						<foreach collection="orgs" item="id" index="index"
							open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</otherwise>

		</choose>

		<if test="date_start != null">
			<![CDATA[  AND time_paid >= #{date_start} ]]>
		</if>

		<if test="date_end != null">
			<![CDATA[ AND time_paid <= #{date_end} ]]>
		</if>

		GROUP BY org_id
	</select>

	<select id="getPayCountTotal"
		resultType="cn.yunovo.iov.fc.model.result.PayCountResultBean">
	
		<![CDATA[
		SELECT org_id, COUNT(pay_id) AS pay_count, SUM(IF(gprs_amount < 9999999, gprs_amount, 0)) AS gprs_amount,
		SUM(gprs_price) AS money_count, SUM(rebate_money) AS rebate_money FROM cc_gprs_pay WHERE is_paid = 1 AND pay_method > 0
		
		]]>

		<choose>

			<when test="org_id != null">
				AND org_id = #{org_id}
			</when>
			<otherwise>
				<choose>
					<when test='orgpos == "*"'>

					</when>
					<otherwise>
						AND org_id IN
						<foreach collection="orgs" item="id" index="index"
							open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</otherwise>

		</choose>

		<if test="date_start != null">
			<![CDATA[  AND time_paid >= #{date_start} ]]>
		</if>

		<if test="date_end != null">
			<![CDATA[ AND time_paid <= #{date_end} ]]>
		</if>

	</select>

	<select id="getOrgPayReportPage"
		resultType="cn.yunovo.iov.fc.model.result.OrgPayReportResultBean">
	
		<![CDATA[
		SELECT count(is_paid) as  paid_count,SUM(IF(is_paid = 1,1,0)) AS paid_amount,
		SUM(IF(is_paid = 0,1,0)) AS nopaid_amount, SUM(IF(is_paid = 1 AND gprs_amount < 9999999, gprs_amount, 0)) AS gprs_amount,
		SUM(IF(is_paid = 1, gprs_price, 0)) AS paid_money, SUM(IF(is_paid = 0, gprs_price, 0)) AS nopaid_money,
		SUM(rebate_money) AS rebate_money, org_id, pay_method, LEFT(time_added, 7) AS mdate FROM cc_gprs_pay WHERE  1=1
		
		]]>

		<choose>

			<when test="org_id != null">
				AND org_id = #{org_id}
			</when>
			<otherwise>
				<choose>
					<when test='orgpos == "*"'>

					</when>
					<otherwise>
						AND org_id IN
						<foreach collection="orgs" item="id" index="index"
							open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</otherwise>

		</choose>
		<choose>

			<when test="pay_method != null">
				AND pay_method = #{pay_method}
			</when>
			<otherwise>
				AND pay_method > 0
			</otherwise>

		</choose>

		<if test="date_start != null">
			<![CDATA[  AND time_added >= #{date_start} ]]>
		</if>

		<if test="date_end != null">
			<![CDATA[ AND time_added <= #{date_end} ]]>
		</if>

		<if test="mdate != null">
			<![CDATA[  AND DATE_FORMAT(time_added, '%Y-%m') = #{mdate} ]]>
		</if>

		GROUP BY org_id, pay_method
	</select>


	<select id="getOrgPayReportTotal"
		resultType="cn.yunovo.iov.fc.model.result.OrgPayReportResultBean">
	
		<![CDATA[
		SELECT count(is_paid) as paid_count,SUM(IF(is_paid = 1,1,0)) AS paid_amount,
		SUM(IF(is_paid = 0,1,0)) AS nopaid_amount, SUM(IF(is_paid = 1 AND gprs_amount < 9999999, gprs_amount, 0)) AS gprs_amount,
		SUM(IF(is_paid = 1, gprs_price, 0)) AS paid_money, SUM(IF(is_paid = 0, gprs_price, 0)) AS nopaid_money,
		SUM(rebate_money) AS rebate_money, org_id, pay_method, LEFT(time_added, 7) AS mdate FROM cc_gprs_pay WHERE  1=1
		
		]]>

		<choose>

			<when test="org_id != null">
				AND org_id = #{org_id}
			</when>
			<otherwise>
				<choose>
					<when test='orgpos == "*"'>

					</when>
					<otherwise>
						AND org_id IN
						<foreach collection="orgs" item="id" index="index"
							open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</otherwise>

		</choose>
		<choose>

			<when test="pay_method != null">
				AND pay_method = #{pay_method}
			</when>
			<otherwise>
				AND pay_method > 0
			</otherwise>

		</choose>

		<if test="date_start != null">
			<![CDATA[  AND time_added >= #{date_start} ]]>
		</if>

		<if test="date_end != null">
			<![CDATA[ AND time_added <= #{date_end} ]]>
		</if>

		<if test="mdate != null and mdate != ''">
			<![CDATA[  AND DATE_FORMAT(time_added, '%Y-%m') = #{mdate} ]]>
		</if>

	</select>

	<select id="getPayListPage"
		resultType="cn.yunovo.iov.fc.model.entity.CcGprsPay">

		SELECT P.*,C.card_iccid, C.card_type FROM cc_gprs_pay P LEFT JOIN
		cc_gprs_card C ON P.card_id = C.card_id WHERE 1=1

		<choose>

			<when test="org_id != null">
				AND P.org_id = #{org_id}
			</when>
			<otherwise>
				<choose>
					<when test='orgpos == "*"'>

					</when>
					<otherwise>
						AND P.org_id IN
						<foreach collection="orgs" item="id" index="index"
							open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</otherwise>

		</choose>

		<if test="pay_sn != null">
			<bind name="pay_sn_bind" value="'%'+pay_sn+'%'" />
			AND P.pay_sn LIKE #{pay_sn_bind}
		</if>

		<if test="card_iccid != null">
			<bind name="card_iccid_bind" value="'%'+card_iccid+'%'" />
			AND C.card_iccid LIKE #{card_iccid_bind}
		</if>

		<if test="card_id != null">
			AND P.card_id = #{card_id}
		</if>

		<if test="card_type != null">
			AND C.card_type = #{card_type}
		</if>

		<if test="transfer_id != null">
			<bind name="transfer_id_bind" value="transfer_id+'%'" />
			AND P.transfer_id LIKE #{transfer_id_bind}
		</if>

		<if test="gprs_amount != null">
			AND P.gprs_amount = #{gprs_amount}
		</if>

		<if test="pay_from != null">
			AND P.pay_from = #{pay_from}
		</if>

		<if test="pay_method != null">
			AND P.pay_method = #{pay_method}
		</if>

		<if test="is_paid != null">
			AND P.is_paid = #{is_paid}
		</if>

		<if test="date_start != null">
			<![CDATA[  AND P.time_added >= #{date_start} ]]>
		</if>

		<if test="date_end != null">
			<![CDATA[ AND P.time_added <= #{date_end} ]]>
		</if>

		<if test="paid_start != null">
			<![CDATA[  AND P.time_paid >= #{paid_start} ]]>
		</if>

		<if test="paid_end != null">
			<![CDATA[ AND P.time_paid <= #{paid_end} ]]>
		</if>

	</select>
	
	<select id="getPayListPageExport"
		resultType="cn.yunovo.iov.fc.model.export.CcGprsPayExportBean">

		SELECT
			P.org_id,P.pack_id,P.gprs_amount,P.gprs_price,P.live_month,P.pay_method,P.rebate_money,C.time_active,C.unicom_total,
			P.transfer_id,P.is_paid,P.time_paid,P.time_added,P.time_expire,C.card_iccid,C.card_type,(SELECT GB.batch_sn FROM cc_gprs_batch GB WHERE GB.batch_id = C.batch_id) AS batch_sn
		FROM cc_gprs_pay P 
		LEFT JOIN cc_gprs_card C ON P.card_id = C.card_id
		WHERE 1=1

		<choose>

			<when test="org_id != null">
				AND P.org_id = #{org_id}
			</when>
			<otherwise>
				<choose>
					<when test='orgpos == "*"'>

					</when>
					<otherwise>
						AND P.org_id IN
						<foreach collection="orgs" item="id" index="index"
							open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</otherwise>

		</choose>

		<if test="pay_sn != null">
			<bind name="pay_sn_bind" value="'%'+pay_sn+'%'" />
			AND P.pay_sn LIKE #{pay_sn_bind}
		</if>

		<if test="card_iccid != null">
			<bind name="card_iccid_bind" value="'%'+card_iccid+'%'" />
			AND C.card_iccid LIKE #{card_iccid_bind}
		</if>

		<if test="card_id != null">
			AND P.card_id = #{card_id}
		</if>

		<if test="card_type != null">
			AND C.card_type = #{card_type}
		</if>

		<if test="transfer_id != null">
			<bind name="transfer_id_bind" value="transfer_id+'%'" />
			AND P.transfer_id LIKE #{transfer_id_bind}
		</if>

		<if test="gprs_amount != null">
			AND P.gprs_amount = #{gprs_amount}
		</if>

		<if test="pay_from != null">
			AND P.pay_from = #{pay_from}
		</if>

		<if test="pay_method != null">
			AND P.pay_method = #{pay_method}
		</if>

		<if test="is_paid != null">
			AND P.is_paid = #{is_paid}
		</if>

		<if test="date_start != null">
			<![CDATA[  AND P.time_added >= #{date_start} ]]>
		</if>

		<if test="date_end != null">
			<![CDATA[ AND P.time_added <= #{date_end} ]]>
		</if>

		<if test="paid_start != null">
			<![CDATA[  AND P.time_paid >= #{paid_start} ]]>
		</if>

		<if test="paid_end != null">
			<![CDATA[ AND P.time_paid <= #{paid_end} ]]>
		</if>
		 ORDER BY P.time_added DESC
	</select>

	<select id="getPayListTotal"
		resultType="cn.yunovo.iov.fc.model.result.PayListTotalResulBean">
	<![CDATA[ 
		SELECT  COUNT(P.pay_id) AS gprs_cards, SUM(IF(gprs_amount < 9999999, gprs_amount, 0.1)) AS gprs_amount, SUM(gprs_price) AS gprs_price, SUM(rebate_money) AS rebate_money  FROM cc_gprs_pay P LEFT JOIN cc_gprs_card C ON P.card_id = C.card_id WHERE 1=1
		]]>
		<choose>

			<when test="org_id != null">
				AND P.org_id = #{org_id}
			</when>
			<otherwise>
				<choose>
					<when test='orgpos == "*"'>

					</when>
					<otherwise>
						AND P.org_id IN
						<foreach collection="orgs" item="id" index="index"
							open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</otherwise>

		</choose>

		<if test="pay_sn != null">
			<bind name="pay_sn_bind" value="'%'+pay_sn+'%'" />
			AND P.pay_sn LIKE #{pay_sn_bind}
		</if>

		<if test="card_iccid != null">
			<bind name="card_iccid_bind" value="'%'+card_iccid+'%'" />
			AND C.card_iccid LIKE #{card_iccid_bind}
		</if>

		<if test="card_id != null">
			AND P.card_id = #{card_id}
		</if>

		<if test="card_type != null">
			AND C.card_type = #{card_type}
		</if>

		<if test="transfer_id != null">
			<bind name="transfer_id_bind" value="transfer_id+'%'" />
			AND P.transfer_id LIKE #{transfer_id_bind}
		</if>

		<if test="gprs_amount != null">
			AND P.gprs_amount = #{gprs_amount}
		</if>

		<if test="pay_from != null">
			AND P.pay_from = #{pay_from}
		</if>

		<if test="pay_method != null">
			AND P.pay_method = #{pay_method}
		</if>

		<if test="is_paid != null">
			AND P.is_paid = #{is_paid}
		</if>

		<if test="date_start != null">
			<![CDATA[  AND P.time_added >= #{date_start} ]]>
		</if>

		<if test="date_end != null">
			<![CDATA[ AND P.time_added <= #{date_end} ]]>
		</if>

		<if test="paid_start != null">
			<![CDATA[  AND P.time_paid >= #{paid_start} ]]>
		</if>

		<if test="paid_end != null">
			<![CDATA[ AND P.time_paid <= #{paid_end} ]]>
		</if>

	</select>
	<select id="getPaidChart"
		resultType="cn.yunovo.iov.fc.model.result.PayListChartDataResultBean">
	<![CDATA[ 
		SELECT COUNT(*) as value,P.is_paid as name FROM cc_gprs_pay P	LEFT JOIN cc_gprs_card C ON P.card_id = C.card_id WHERE 1 = 1
		]]>
		<choose>

			<when test="org_id != null">
				AND P.org_id = #{org_id}
			</when>
			<otherwise>
				<choose>
					<when test='orgpos == "*"'>

					</when>
					<otherwise>
						AND P.org_id IN
						<foreach collection="orgs" item="id" index="index"
							open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</otherwise>

		</choose>

		<if test="pay_sn != null">
			<bind name="pay_sn_bind" value="'%'+pay_sn+'%'" />
			AND P.pay_sn LIKE #{pay_sn_bind}
		</if>

		<if test="card_iccid != null">
			<bind name="card_iccid_bind" value="'%'+card_iccid+'%'" />
			AND C.card_iccid LIKE #{card_iccid_bind}
		</if>

		<if test="card_id != null">
			AND P.card_id = #{card_id}
		</if>

		<if test="card_type != null">
			AND C.card_type = #{card_type}
		</if>

		<if test="transfer_id != null">
			<bind name="transfer_id_bind" value="transfer_id+'%'" />
			AND P.transfer_id LIKE #{transfer_id_bind}
		</if>

		<if test="gprs_amount != null">
			AND P.gprs_amount = #{gprs_amount}
		</if>

		<if test="pay_from != null">
			AND P.pay_from = #{pay_from}
		</if>

		<choose>
			<when test="pay_method != null">
				AND P.pay_method = #{pay_method}
			</when>
			<otherwise>
				AND P.pay_method > 0
			</otherwise>
		</choose>

		<if test="is_paid != null">
			AND P.is_paid = #{is_paid}
		</if>

		<if test="date_start != null">
			<![CDATA[  AND P.time_added >= #{date_start} ]]>
		</if>

		<if test="date_end != null">
			<![CDATA[ AND P.time_added <= #{date_end} ]]>
		</if>

		<if test="paid_start != null">
			<![CDATA[  AND P.time_paid >= #{paid_start} ]]>
		</if>

		<if test="paid_end != null">
			<![CDATA[ AND P.time_paid <= #{paid_end} ]]>
		</if>
		
		 GROUP BY is_paid

	</select>
	
	<select id="getMethodChart"
		resultType="cn.yunovo.iov.fc.model.result.PayListChartDataResultBean">
		<![CDATA[ 
	
		SELECT COUNT(*) AS `value`, P.pay_method AS name, SUM(P.gprs_price) as price
		FROM cc_gprs_pay P LEFT JOIN cc_gprs_card C ON P.card_id = C.card_id WHERE  1 = 1
		]]>
		<choose>

			<when test="org_id != null">
				AND P.org_id = #{org_id}
			</when>
			<otherwise>
				<choose>
					<when test='orgpos == "*"'>

					</when>
					<otherwise>
						AND P.org_id IN
						<foreach collection="orgs" item="id" index="index"
							open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</otherwise>
		</choose>

		<if test="pay_sn != null">
			<bind name="pay_sn_bind" value="'%'+pay_sn+'%'" />
			AND P.pay_sn LIKE #{pay_sn_bind}
		</if>

		<if test="card_iccid != null">
			<bind name="card_iccid_bind" value="'%'+card_iccid+'%'" />
			AND C.card_iccid LIKE #{card_iccid_bind}
		</if>

		<if test="card_id != null">
			AND P.card_id = #{card_id}
		</if>

		<if test="card_type != null">
			AND C.card_type = #{card_type}
		</if>

		<if test="transfer_id != null">
			<bind name="transfer_id_bind" value="transfer_id+'%'" />
			AND P.transfer_id LIKE #{transfer_id_bind}
		</if>

		<if test="gprs_amount != null">
			AND P.gprs_amount = #{gprs_amount}
		</if>

		<if test="pay_from != null">
			AND P.pay_from = #{pay_from}
		</if>

		<choose>
			<when test="pay_method != null">
				AND P.pay_method = #{pay_method}
			</when>
			<otherwise>
				AND P.pay_method > 0
			</otherwise>
		</choose>

		<if test="is_paid != null">
			AND P.is_paid = #{is_paid}
		</if>

		<if test="date_start != null">
			<![CDATA[  AND P.time_added >= #{date_start} ]]>
		</if>

		<if test="date_end != null">
			<![CDATA[ AND P.time_added <= #{date_end} ]]>
		</if>

		<if test="paid_start != null">
			<![CDATA[  AND P.time_paid >= #{paid_start} ]]>
		</if>

		<if test="paid_end != null">
			<![CDATA[ AND P.time_paid <= #{paid_end} ]]>
		</if>
		
		 GROUP BY P.pay_method

	</select>
	
	<select id="getPayPackPage" resultType="cn.yunovo.iov.fc.model.result.PayPackResultBean">

		SELECT gprs_price, gprs_amount,count(is_paid) as pay_count,	SUM(IF(is_paid = 1, 1, 0)) AS paid_count, SUM(IF(is_paid = 0, 1, 0)) AS nopaid_count,
		SUM(IF(is_paid = 1, gprs_price, 0)) AS paid_money, SUM(IF(is_paid = 0, gprs_price, 0)) AS nopaid_money FROM cc_gprs_pay WHERE 1 = 1
		
		<choose>

			<when test="org_id != null">
				AND org_id = #{org_id}
			</when>
			<otherwise>
				<choose>
					<when test='orgpos == "*"'>

					</when>
					<otherwise>
						AND org_id IN
						<foreach collection="orgs" item="id" index="index" open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</otherwise>

		</choose>
		
		<if test="date_start != null">
			<![CDATA[  AND time_added >= #{date_start} ]]>
		</if>

		<if test="date_end != null">
			<![CDATA[ AND time_added <= #{date_end} ]]>
		</if>
		
		<choose>

			<when test="pay_method != null">
				AND pay_method = #{pay_method}
			</when>
			<otherwise>
				AND pay_method > 0
			</otherwise>

		</choose>
		
		 GROUP BY gprs_price, gprs_amount
		
	</select>
	
	
	<select id="getPayPackTotal" resultType="cn.yunovo.iov.fc.model.result.PayPackResultBean">

		SELECT gprs_price, gprs_amount,	count(is_paid) as pay_count, SUM(IF(is_paid = 1, 1, 0)) AS paid_count, SUM(IF(is_paid = 0, 1, 0)) AS nopaid_count,
		SUM(IF(is_paid = 1, gprs_price, 0)) AS paid_money, SUM(IF(is_paid = 0, gprs_price, 0)) AS nopaid_money FROM cc_gprs_pay WHERE 1 = 1
		
		<choose>

			<when test="org_id != null">
				AND org_id = #{org_id}
			</when>
			<otherwise>
				<choose>
					<when test='orgpos == "*"'>

					</when>
					<otherwise>
						AND org_id IN
						<foreach collection="orgs" item="id" index="index" open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</otherwise>

		</choose>
		
		<if test="date_start != null">
			<![CDATA[  AND time_added >= #{date_start} ]]>
		</if>

		<if test="date_end != null">
			<![CDATA[ AND time_added <= #{date_end} ]]>
		</if>
		
		<choose>

			<when test="pay_method != null">
				AND pay_method = #{pay_method}
			</when>
			<otherwise>
				AND pay_method > 0
			</otherwise>

		</choose>
		
	</select>
	
	<select id="getMonthCountPage" resultType="cn.yunovo.iov.fc.model.result.MonthPayReportResultBean">
	
		<![CDATA[ 
			SELECT org_id, count(is_paid) as pay_count, SUM(IF(is_paid = 1, 1, 0)) AS paid_count, SUM(IF(is_paid = 0, 1, 0)) AS nopaid_count,
			SUM(IF(is_paid = 1 AND gprs_amount < 9999999, gprs_amount, 0)) AS gprs_amount, SUM(IF(is_paid = 1, gprs_price, 0)) AS paid_money,
			SUM(IF(is_paid = 0, gprs_price, 0)) AS nopaid_money, SUM(rebate_money) AS rebate_money, LEFT(time_added, 7) AS mdate FROM cc_gprs_pay WHERE pay_method > 0
		]]>		
		<choose>

			<when test="org_id != null">
				AND org_id = #{org_id}
			</when>
			<otherwise>
				<choose>
					<when test='orgpos == "*"'>

					</when>
					<otherwise>
						AND org_id IN
						<foreach collection="orgs" item="id" index="index" open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</otherwise>

		</choose>
		
		GROUP BY org_id, mdate
		
		<if test="mdate != null and mdate != ''">
			 HAVING mdate = #{mdate}
		</if>
		
	</select>
	
	<!-- 获取机构下的充值与返利情况 -->
	<select id="getPayCase" resultType="java.util.HashMap">
	
	SELECT COUNT(*) AS pay_count, SUM(gprs_price) AS pay_money, SUM(rebate_money) AS rebate_money
		FROM cc_gprs_pay WHERE 1 = 1 
		
		
		<choose>
			<when test='orgpos == "*"'>

			</when>
			<otherwise>
				AND org_id IN
				<foreach collection="orgs" item="id" index="index"
					open="(" close=")" separator=",">
					#{id}
				</foreach>
			</otherwise>
		</choose>
		
		
		AND is_paid = 1 AND pay_method > 0
		
		<if test="date_start != null">
			 AND time_paid >= #{date_start}
		</if>
		
		<if test="date_end != null">
			<![CDATA[  AND time_paid <= #{date_end} ]]>
		</if>
	
	</select>
	
	<!-- 获取今日机构下的充值与返利情况 -->
	<!-- <select id="getJRPayData" resultType="java.util.HashMap">
	
		SELECT COUNT(*) AS pay_count, SUM(gprs_price) AS pay_money, SUM(rebate_money) AS rebate_money
		FROM cc_gprs_pay WHERE 1 = 1
		
		<choose>
			<when test='orgpos == "*"'>

			</when>
			<otherwise>
				AND org_id IN
				<foreach collection="orgs" item="id" index="index"
					open="(" close=")" separator=",">
					#{id}
				</foreach>
			</otherwise>
		</choose>
		<![CDATA[ 
		 AND is_paid = 1 AND pay_method > 0 AND time_paid >= #{date_start} AND time_paid <=  #{date_end}
		]]>
		
	</select> -->
	
	<!-- 获取今日及今月激活数 -->
	<select id="getJRActiveData" resultType="java.util.HashMap">
		<![CDATA[ 
			SELECT COUNT(pay_id) AS active_month, SUM(IF(DATE(time_added) = DATE(NOW()), 1, 0)) AS active_today FROM cc_gprs_pay
			WHERE time_added >= #{date_start} AND time_added <= NOW() AND is_paid = 1 AND pay_method = 0 AND transfer_id = 'system-init'
		]]>
		<choose>
			<when test='orgpos == "*"'>

			</when>
			<otherwise>
				AND org_id IN
				<foreach collection="orgs" item="id" index="index"
					open="(" close=")" separator=",">
					#{id}
				</foreach>
			</otherwise>
		</choose>
		
	</select>
	
	<!-- 首页-获取当月续费机构下的当月流量卡统计 -->
	<select id="getDYPayCase" resultType="java.util.HashMap">
		<![CDATA[ 
			SELECT COUNT(*) AS pay_count, COUNT(DISTINCT card_id) AS card_pay,
			SUM(gprs_price) AS pay_money, SUM(rebate_money) AS rebate_money
			FROM cc_gprs_pay WHERE 1 = 1
		]]>
		<choose>
			<when test='orgpos == "*"'>

			</when>
			<otherwise>
				AND org_id IN
				<foreach collection="orgs" item="id" index="index"
					open="(" close=")" separator=",">
					#{id}
				</foreach>
			</otherwise>
		</choose>
		
		AND is_paid = 1 AND pay_method > 0 AND time_paid >= #{date_start}
	</select>
	
	<select id="getSYPayCase" resultType="java.util.HashMap">
	
		SELECT COUNT(*) AS pay_count, COUNT(DISTINCT card_id) AS card_pay,
		SUM(gprs_price) AS pay_money, SUM(rebate_money) AS rebate_money
		FROM cc_gprs_pay WHERE  1=1
		<choose>
			<when test='orgpos == "*"'>

			</when>
			<otherwise>
				AND org_id IN
				<foreach collection="orgs" item="id" index="index"
					open="(" close=")" separator=",">
					#{id}
				</foreach>
			</otherwise>
		</choose>
		<![CDATA[ 
			AND is_paid = 1 AND pay_method > 0 AND time_paid >= #{date_start} AND time_paid <=  #{date_end}
		]]>
	</select>


	<select id="listPaysnByCardidAndPaymethodAndIspaid" resultType="java.lang.String">
		SELECT pay_sn FROM cc_gprs_pay WHERE card_id = #{card_id} AND pay_method > 0 AND is_paid = 1
	</select>
	
	<select id="listPaysnByCardid" resultType="java.lang.String">
		SELECT pay_sn FROM cc_gprs_pay WHERE card_id = #{card_id} 
	</select>
	
	<select id="isBuyOtherGprs" resultType="java.lang.String">
	
		SELECT pay_sn FROM cc_gprs_pay WHERE card_id = #{card_id} AND pay_method > 0 AND is_paid = 1 AND gprs_amount != 0.02
	</select>
	
	<update id="updatePayMethodByCardid" >
	
			UPDATE cc_gprs_pay SET pay_method = -1, time_expire = NOW() WHERE card_id = #{card_id}
	</update>
	
	<insert id="savePay" parameterType="cn.yunovo.iov.fc.model.entity.CcGprsPay" >
	
		INSERT INTO cc_gprs_pay (
			pay_sn,
			card_id,
			org_id,
			pack_id,
			gprs_amount,
			gprs_price,
			live_month,
			pay_from,
			pay_memo,
			pay_method,
			rebate_value,
			rebate_money,
			transfer_id,
			is_paid,
			time_paid,
			time_added,
			time_expire
		)
		VALUES
			(
			#{pay.pay_sn},
			#{pay.card_id},
			#{pay.org_id},
			#{pay.pack_id},
			#{pay.gprs_amount},
			#{pay.gprs_price},
			#{pay.live_month},
			#{pay.pay_from},
			#{pay.pay_memo},
			#{pay.pay_method},
			#{pay.rebate_value},
			#{pay.rebate_money},
			#{pay.transfer_id},
			#{pay.is_paid},
			#{pay.time_paid},
			#{pay.time_added},
			#{pay.time_expire}
			)
	</insert>
	
	
	<select id="getAllMonth" resultType="java.lang.String">
	
		SELECT LEFT(time_added, 7) AS mdate FROM cc_gprs_pay  WHERE 1 = 1
		<choose>
			<when test='orgpos == "*"'>

			</when>
			<otherwise>
				AND org_id IN
				<foreach collection="orgs" item="id" index="index"
					open="(" close=")" separator=",">
					#{id}
				</foreach>
			</otherwise>
		</choose>
		
		 GROUP BY mdate ORDER BY mdate DESC
	</select>
</mapper>
